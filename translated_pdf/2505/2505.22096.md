知识增强型Text-to-SQL的知识库建设




Jinheon Baek 1 \* Horst Samulowitz 2 Oktie Has sanz a deh 2 Dharma shankar Subramania n 2 Sola Shirai 2 Alfio Gliozzo 2 Debarun Bhatt a char jy a 2 韩国科学技术院1 IBM研究院2 jinheon.baek@kaist.ac.kr {samulowitz, has sanz a deh}@us.ibm.com dharmash@us.ibm.com solashirai@ibm.com {gliozzo, debarunb}@us.ibm.com

摘要

文本转SQL技术致力于将自然语言查询转换为SQL语句，让普通用户也能轻松获取数据库信息。当前主流方法依托大型语言模型（LLMs）强大的语义理解和代码生成能力，但其参数化知识往往难以覆盖需要特定数据库模式支撑的多样化领域查询，导致生成的SQL准确性欠佳。为此，我们创新性地构建了文本转SQL知识库——通过整合所有可用问题、关联数据库模式及相关知识，形成可复用的知识体系。不同于现有仅提供少量人工标注或自动生成知识的方案，我们的知识库具有全面性优势，能适配不同数据集和领域的未知数据库。在多个文本转SQL基准测试中，无论是数据库重叠还是非重叠场景，该方法均显著超越现有基线模型。

1 引言

文本转SQL技术（Text-to-SQL）致力于将自然语言查询转化为可执行的SQL语句，实现用户与数据库的无缝交互（Zelle和Mooney，1996；Xu等，2017；Yaghmazadeh等，2017；Cai等，2018），如图1(A)所示。这项技术让普通用户无需掌握专业数据库语言即可查询数据，因此备受关注。近年来，大型语言模型（LLMs）展现出强大的文本与代码处理能力（Rajkumar等，2022；Gao等，2024），为文本转SQL带来了新的突破。

然而，由于需要特定领域知识和数据库结构理解，即使是最先进的LLM模型也难以在所有数据集上保持高准确率（Li等，2023）。以查询"X公司的WACC是多少？"为例，模型不仅要理解加权平均资本成本（WACC）的计算方法（涉及股权成本、债务成本及其资本结构占比），还需掌握金融数据库中分布在"股权"、"债务"等表格中的数据关系。

针对领域知识缺失的问题，现有研究主要通过人工标注显式知识来辅助SQL生成（Dou等，2022；Li等，2023）。但这种方法依赖大量人工标注，面对海量数据库的多样化知识需求时效率低下。最新研究尝试根据查询自动生成相关知识（Hong等，2024，见图1(B)），有趣的是，某些知识可跨查询复用，甚至适用于不同数据库（图1右）。

受此启发，我们提出自动构建知识库的方法：通过LLM提示，基于样本数据及其数据库模式生成规范化知识条目，建立可支持多数据库查询的领域知识库。在构建过程中，我们提供示例引导LLM生成与数据库结构相符的知识。使用时，系统会检索知识库中相关条目辅助SQL生成。当遇到知识库未覆盖的查询时，现有知识仍能提供重要参考，通过LLM推理生成适配的新知识。我们将该方法命名为KAT-SQL（知识增强型文本转SQL），如图1(C)所示。

实验表明，KAT-SQL在训练/测试集数据库重叠与非重叠两种场景下，均超越现有知识增强型基线模型。更令人振奋的是，基于某数据集构建的知识库，迁移到其他未标注数据集时仍能显著提升SQL生成效果，展现出卓越的泛化能力。

2 相关研究




LLM赋能的文本转SQL 大语言模型（LLM）凭借强大的自然语言理解与结构化代码生成能力（Rajkumar等，2022；Gao等，2024），在文本转SQL等任务中展现出卓越性能（OpenAI，2023；Anil等，2023；AI@Meta，2024）。该领域主要聚焦三大方向：一是优化提示技术，包括思维链（Wei等，2022）、复杂提示策略（Chang等，2023）和多提示结果聚合（Lee等，2024）；二是任务分解法，通过多模型协作生成最终SQL（Gu等，2023）；三是引入外部知识，以弥补LLM在专业领域知识储备的不足。





知识增强方案 现有研究主要通过两种途径注入知识：Dou等（2022）构建公式化知识库，Li等（2023）则标注大规模人工知识数据集。但后者成本高昂，促使Hong等（2024）转向自动知识生成。本研究突破性地提出构建可扩展的跨领域知识库，相比零散知识注入更具系统性优势。





LLM数据生成革命 以Self-Instruct（Wang等，2023c）为代表的方法通过提示工程批量生成训练数据，大幅降低人工标注成本。虽然LLM能构建百科全书式知识库（如Wikidata），但这些通用知识与文本转SQL需求存在鸿沟。本研究首创的自动构建技术，填补了领域适配知识库的空白。

3 方法论




本节我们将介绍KAT-SQL（知识增强型文本转SQL）技术，该方案能自动构建知识库，并智能调用相关知识来实现文本到SQL的转换。

3.1 问题陈述

我们首先明确定义文本到SQL任务及其知识增强技术。

文本到SQL 该技术旨在将用户的自然语言查询精准转换为符合语法且语义准确的SQL语句。具体而言，设$\pmb q$为用户查询（由词元序列构成），$\mathcal{D}$为包含多表多列的数据库结构。SQL生成模型$f$可表示为：$\pmb{s}=f(\pmb{q},\mathcal{D})$，其中$\mathbf{\nabla}_{\mathbf{S}}$是目标SQL语句（由词元序列组成），用于在$\mathcal{D}$中检索$q$所需信息。

本研究采用大语言模型（LLM）实现$f$，利用其强大的语义理解与SQL生成能力：$\pmb{s}=\mathsf{L L M}_{\theta}(\mathcal{T}(\pmb{q},\mathcal{D}))$。其中θ为模型参数，$\mathcal{T}$为提示模板。由于微调成本高昂且参数访问受限，θ通常保持固定。提示模板$\mathcal{T}$通过结构化格式整合任务说明、操作指引和示例演示，指导模型生成准确SQL。尽管当前在LLM优化（如高级提示技术、任务分解等）方面取得显著进展（Wei等，2022；Liu等，2023），但这些改进仍难以应对需要深度领域知识或复杂库表理解的查询。LLM的固有参数知识虽强，却难以覆盖多样化的查询变体与专业数据库结构。

知识增强方案 为突破这一局限，我们引入查询相关的外部知识$k$来增强模型表现：$\pmb{s}=\mathsf{L L M}_{\theta}(\mathcal{T}(\pmb{q},\pmb{k},\mathcal{D}))$。现有研究存在明显不足：Dou等（2022）和Li等（2023）采用人工标注显式知识的方法成本过高；Hong等（2024）虽实现知识自动生成，但未充分利用知识的可复用性（如图1右所示）。我们旨在构建更高效的知识增强框架，详见下文。

3.2 知识库构建

针对现有文本转SQL知识增强方案的不足，我们创新性地提出自动化构建全方位可复用知识库的方法。该知识库旨在成为基础资源平台，汇聚多领域信息并解析各类数据库模式，从而深度理解查询语句及其关联的数据库结构。

我们采用结构化设计，将知识库$\mathcal{K}$定义为由精炼语句构成的知识条目集合($k\in\mathcal K$)。以医疗领域为例，"白细胞异常指$\mathrm{WBC}\leq3.5$或$\mathrm{WBC}\geq9.0$"这样的条目，既明确了医学标准又标注了数据库字段"WBC"，可精准支持相关查询。接下来重点在于如何基于现有资源高效构建这一知识库。

研究首先从公开数据集(Li等，2023)整合现有知识条目，这些数据包含知识单元及其对应的查询-数据库模式组合。虽然这些基础数据能构建知识库雏形，但覆盖范围有限。为此我们引入基于大语言模型(LLM)的智能扩展技术：通过模板$\mathcal{T}$引导模型理解查询$\pmb{q}$和数据库$\mathcal{D}$的上下文关系，自动生成新知识$\pmb{k}=\mathsf{L L M}(\mathcal{T}(\pmb{q},\mathcal{D}))$并存入知识库。为提升生成质量，我们创新性地采用"示例引导"机制——精选现有数据集中与当前查询语义相似的三元组(查询-模式-知识)作为提示前缀，相似度计算采用MPNet(Song等，2020)的嵌入向量余弦值。

更进一步，我们设计了"动态上下文采样"策略：对同一查询多次重组不同的少样本示例及其排列顺序，激发LLM从多角度生成差异化知识。这种方法不仅能捕捉更丰富的语义细节，还显著提升了知识库应对多样化查询的适应能力，实现"一次构建，广泛适用"的智能增强效果。

3.3 知识库驱动的文本转SQL技术

依托LLM构建的知识库$\mathcal{K}$已然就绪，接下来要解决的核心问题是：给定包含查询-数据库对$(\pmb q,\mathcal{D})$的数据集$_D$，结合LLM模型与提示模板$\mathcal{T}$，如何精准生成对应查询$\pmb q$的SQL语句$s$。

【知识库构建阶段】
1. 初始化知识库：$\mathcal{K}\leftarrow\{\}\cup D$
2. 遍历数据集$\mathcal{D}$中的每个$(\pmb q,\mathcal{D})$：
   - 采样$k$个典型示例
   - 通过LLM生成新知识：$k_{\mathrm{new}}\gets\mathsf{LLM}(\mathcal{T}_{\mathrm{gen}})$
   - 将新知识存入知识库：$\mathcal{K}\leftarrow\mathcal{K}\cup k_{\mathrm{new}}$

【SQL生成阶段】
1. 知识检索：从$\kappa$获取前$j$条相关知识$\{k_{i}\}_{i=1}^{j}$
2. 知识精炼：$\pmb{k}^{\prime}\leftarrow\mathsf{LLM}(\mathcal{T}_{\mathrm{ref}})$
3. SQL生成：$s\gets\mathsf{LLM}(\mathcal T_{\mathrm{ext-to-SQR}})$

知识库应用方法论

面对海量知识库$\mathcal{K}$，精准检索与查询$\pmb q$最相关的知识条目是关键。我们采用基于嵌入相似度的检索机制：
1. 使用句子嵌入模型（Karpukhin等，2020）计算查询与知识条目的语义相似度
2. 通过对比学习优化模型，其损失函数为：
   $\mathcal{L}=-\log\frac{e^{sim(q,k^+)/\tau}}{e^{sim(q,k^+)/\tau}+\sum_{k^-}e^{sim(q,k^-)/\tau}}$
   其中$\tau$为温度参数，$k^+$表示正样本

值得注意的是，初始检索的知识可能需要二次加工。例如当查询涉及异常数据而检索到正常数据知识时，我们通过LLM进行知识定制：
$\pmb{k}^{\prime}=\mathsf{LLM}(\mathscr{T}(\pmb{q},\{\pmb{k}_{i}\}_{i=1}^{j},\mathscr{D}))$
最终结合精炼后的知识$k^{\prime}$、原始查询和数据库模式，生成精准SQL：
$\pmb{s}=\mathsf{LLM}(\mathcal{T}(\pmb{q},\pmb{k}^{\prime},\mathcal{D}))$
完整算法流程详见算法1。

4 实验配置

4.1 数据集与实验设计

数据集 我们选用两大主流文本转SQL基准数据集验证KAT-SQL：BIRD（Li等，2023）和Spider（Yu等，2018）。BIRD作为新兴大规模数据集，覆盖37个领域的95个异构数据库，其独特优势在于每个查询都附带人工标注的知识指引。Spider则包含138个领域的200个数据库，但缺乏知识标注。此外，我们引入真实业务场景数据集CSTINSIGHT，该数据集基于含34张表的数据湖屋客户查询构建，全程无人工知识干预。

实验场景 设计三类测试场景：1）知识重叠场景：训练集与测试集共享相同数据库，部分样本附带预标注知识（模拟实际标注可行性）；2）零重叠场景：采用标准基准测试设置，训练与测试数据库完全隔离，考验模型跨库泛化能力；3）极限挑战场景：不仅数据库完全隔离，所有样本均不提供知识标注（使用Spider和CSTINSIGHT）。特别说明：BIRD数据集用于前两个场景，后两个无知识数据集专攻第三场景。

表1：跨场景文本转SQL基准测试结果（最优值加粗呈现）

4.2 基准方案与我们的模型

我们对比了KAT-SQL方法与以下知识增强型文本转SQL方案的性能差异（均采用相同大语言模型以确保公平性）：
1. 无知识基准：仅基于原始查询生成SQL
2. DELLM方案：动态生成数据库相关知识辅助SQL生成（Hong等，2024）
3. KAT-SQL方案：通过构建可检索知识库实现知识增强
4. 完美知识基准（理论上限）：使用人工标注的理想知识，因依赖高质量人工标注数据而不具备实际可比性

4.3 评估指标

基于前人研究的标准评估方法（Li等人，2023；Hong等人，2024），我们采用两项核心指标：1）执行准确率（EX）——对比生成SQL与标准SQL的执行结果匹配度；2）有效效率得分（VES）——通过计算生成SQL相对于标准SQL的效率提升权重，再结合执行准确率综合评估性能。

![](images/d293323e8eeec0a9d578960f5e01a35a76097f11656936b1e8be5cf044c637b3.jpg)  

图3：不同知识生成步骤下，构建知识库的条目覆盖率与相关性分析（与标准知识对比）。

4.4 实现细节

为确保公平对比，我们主要采用Llama-3 70B（AI @ Meta，2024）作为核心模型，为所有基线及模型变体执行文本转SQL和知识生成任务。同时通过多模型对比实验（表6）验证KAT-SQL的鲁棒性。超参数方面，除将温度设为0.0以保证结果可复现外，其余均保持默认设置。检索模块选用基于稠密检索的MPNet（Song等，2020），训练时采用128的批大小和30个训练轮次。具体知识引导和SQL生成的提示模板详见附录A。

五、实验结果与深度解析

核心发现 如表1所示，我们的KAT-SQL方案以显著优势全面超越基线模型。值得注意的是，虽然知识增强型文本转SQL方案（如DELLM）较无知识增强的基准线有所提升，但KAT-SQL展现出更大幅度的性能飞跃，这有力验证了我们基于知识库构建的文本转SQL框架的优越性。不过，采用专家标注的黄金知识（oracle）的参照模型仍保持领先优势，这为未来开发更智能的知识生成链路指明了方向。

知识库深度剖析 图3揭示：在训练测试集重叠场景下，知识库可覆盖50%的查询需求，语义匹配度高达90%；即便在跨数据库的严苛测试中，仍能满足20%的知识需求并保持80%以上的语义契合度。随着知识生成步骤的增加，知识库的覆盖广度和内容质量呈现同步提升，充分印证了我们采用的动态扩展策略的有效性。

知识生成优化 表2数据显示：通过知识库检索优化后的知识生成方案，其产出质量显著优于原始方法。引入相似度筛选的few-shot示例后，生成知识的精准度获得进一步提升。表3进一步证明：相较于直接使用检索结果，经过精加工的知识能为文本转SQL任务带来额外增益，这凸显了知识定制化的重要性。

跨领域泛化能力 如表5所示，虽然领域差异会导致性能折损，但KAT-SQL在陌生领域仍保持明显优势。特别是在采用Li等人（2023）划分的37个领域测试中，系统展现出令人满意的迁移能力。

大模型兼容性测试 表6呈现了在不同大语言模型（如Granite 34B和Mixtral 8x7B）上的测试结果，KAT-SQL始终稳居榜首，证明了方案的强适应性和普适性。

实战性能突破 如表7所示，当我们的知识增强方案与当前BIRD榜单冠军模型EXPSL+granite-20b-code结合时，创造了文本转SQL任务的新标杆。

效能优化 尽管知识增强会使输入提示增长30%，但得益于高效的检索算法（仅占2%耗时），系统能在5秒内完成全流程处理。知识库的离线构建机制也确保了对实时查询零干扰。

典型案例 表8展示了知识生成与SQL转换的实际案例，表9则呈现了知识库中原始知识与优化后条目的对比样本，直观展现了系统的处理能力。

6 结论

本研究创新性地提出了KAT-SQL方法——一种基于知识库构建的文本转SQL技术，其核心思想在于实现知识片段在多查询、多数据库场景下的复用。我们通过构建知识库来检索并运用相关知识生成SQL语句。经多数据集、双场景的全面测试表明，KAT-SQL性能显著优于现有知识增强型基线方法。深入分析不仅验证了知识生成与检索各模块的有效性，更展现了知识库条目出色的覆盖广度与关联精准度。

研究局限




本研究通过构建知识库并将其应用于文本转SQL任务，充分证明了知识库建设的重要价值。但实验数据显示，基于理想知识(oracle)的模型性能仍显著优于依赖自建知识库的模型，这说明当前知识库的覆盖范围仍有提升空间。未来研究可探索更先进的知识库构建方法，这将成为极具潜力的发展方向。

伦理声明




我们深知，包括本方案在内的所有文本转SQL系统，都可能存在固有风险——生成的SQL查询可能意外或蓄意访问、修改甚至删除数据库中的敏感数据。这一隐患并非本方案独有，实为整个文本转SQL领域的共性难题，正因如此，在部署前必须建立严密的安全防护与权限管控机制。特别需要强调的是，在本应用场景中，必须严防敏感信息被存入知识库后遭到违规调用，因此系统安全性更显至关重要。